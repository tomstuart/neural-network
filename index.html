<!doctype html>

<html>
  <head>
    <meta charset="utf-8">
    <script src="neural_network.js"></script>
    <style>
      canvas {
        float: left;
      }
    </style>
  </head>

  <body>
    <canvas id="canvas" width="500" height="500"></canvas>
    <p>
      <button id="toggle-training">Start training</button>
    </p>
    <p>
      <button id="reset-neural-network">Reset neural network</button>
    </p>
    <p>
      <form id="training-set">
        <input id="training-set-size" type="text" value="1000">
        <button id="new-training-set">New training set</button>
      </form>
    </p>

    <script>
      var neuralNetwork = new NeuralNetwork();
      var training = false;

      var canvas = document.getElementById('canvas');
      var context = canvas.getContext('2d');

      var minX = -1;
      var minY = -1;
      var maxX = 1;
      var maxY = 1;

      var width = maxX - minX;
      var height = maxY - minY;

      var xScale = canvas.width / width;
      var yScale = canvas.height / height;

      var lineWidth = 1;

      context.scale(xScale, yScale);
      context.translate(-minX, -minY);
      context.lineWidth = lineWidth / xScale;

      var rectangularToPolar = function (p) {
        magnitude = Math.sqrt(p.x * p.x + p.y * p.y);
        angle = Math.atan(p.y / p.x);

        if (p.x < 0) {
          angle += Math.PI;
        }
        if (p.y < 0 && p.x > 0) {
          angle += 2 * Math.PI;
        }

        return { magnitude: magnitude, angle: angle };
      };

      var drawBackground = function () {
        context.clearRect(minX, minY, width, height);

        context.strokeStyle = 'red';

        context.setLineDash([0.01, 0.03]);
        context.beginPath();
        context.arc(0, 0, 1, 0, Math.PI * 2);
        context.stroke();

        context.setLineDash([]);
        context.beginPath();
        context.moveTo(minX, 0);
        context.lineTo(maxX, 0);
        context.moveTo(0, minY);
        context.lineTo(0, maxY);
        context.stroke();
      };

      var drawOutput = function (expectedX, expectedY, actualX, actualY) {
        context.strokeStyle = 'black';
        context.beginPath();
        context.moveTo(expectedX, expectedY);
        context.lineTo(actualX, actualY);
        context.stroke();
        context.beginPath();
        context.arc(actualX, actualY, 0.01, 0, Math.PI * 2);
        context.fill();
      };

      var generateTrainingSet = function (size) {
        var trainingSet = [];

        for (var i = 0; i < size; ++i) {
          while (true) {
            rectangular = {
              x: minX + width * Math.random(),
              y: minY + height * Math.random()
            }

            if (rectangular.x * rectangular.x + rectangular.y * rectangular.y <= 1) {
              break;
            }
          };

          trainingSet[i] = {
            rectangular: rectangular,
            polar: rectangularToPolar(rectangular)
          };
        };

        return trainingSet;
      };

      var trainingSet = generateTrainingSet(document.getElementById('training-set-size').value);

      var update = function () {
        drawBackground();

        for (var i = 0; i < trainingSet.length; ++i) {
          var element = trainingSet[i];
          var rectangular = element.rectangular;
          var polar = element.polar;

          neuralNetwork.compute(polar.magnitude, polar.angle);
          if (training) {
            neuralNetwork.learn(rectangular.x, rectangular.y);
          }

          drawOutput(rectangular.x, rectangular.y, neuralNetwork.output[0], neuralNetwork.output[1]);
        }

        window.requestAnimationFrame(update);
      };

      update();

      document.getElementById('toggle-training').addEventListener('click', function (event) {
        training = !training;

        if (training) {
          event.target.textContent = 'Stop training';
        } else {
          event.target.textContent = 'Start training';
        }
      });

      document.getElementById('reset-neural-network').addEventListener('click', function () {
        neuralNetwork = new NeuralNetwork();
      });

      document.getElementById('training-set').addEventListener('submit', function (event) {
        event.preventDefault();
        trainingSet = generateTrainingSet(document.getElementById('training-set-size').value);
      });
    </script>
  </body>
</html>
